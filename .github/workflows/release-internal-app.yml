name: Release internal app
on:
  push:
    tags:
      - internal*
jobs:
  # increment-versions:
  #   name: Increment Android and Ios versions
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Increment versions
  #       run: |
  #         bash ./scripts/increment_android_version_code.sh
  #         bash ./scripts/increment_android_version_name.sh
  #         bash ./scripts/update_ios_version_code.sh $(bash ./scripts/get_android_version_code.sh)
  #         bash ./scripts/update_ios_version_name.sh $(bash ./scripts/get_android_version_name.sh)
  #         git status
  #         git --no-pager diff
  #       working-directory: react-native-app
  #     - run: |
  #         git config --global user.email "symbio.devops@gmail.com"
  #         git config --global user.name "symbio-devops"
  #         git config -l
  #     - run: git add android/gradle.properties ios/Symbio/Info.plist
  #       working-directory: react-native-app
  #     - run: git commit -m "Version Bump[ci skip]"
  #     - uses: ad-m/github-push-action@master
  #       with:
  #         github_token: ${{ secrets.DEVOPS_TOKEN }}
  #     - run: echo 'new version successfully pushed'
  # deploy-android-internal:
  #   needs: increment-versions
  #   name: Deploy Android internal
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: bahmutov/npm-install@v1
  #     - name: Recreate Google Play upload key
  #       run: echo "${{secrets.GOOGLE_PLAY_ENCODED_KEYSTORE}}" | base64 -d > react-native-app/android/app/google-play-upload-key.keystore
  #     - name: Recreate Service Account json file
  #       run: echo "${{secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON}}" | base64 -d > react-native-app/fastlane/google-play.json
  #     - name: Recreate production environment
  #       run: echo "${{secrets.REACT_NATIVE_APP_ENV_PROD}}" | base64 -d > react-native-app/env.prod.ts
  #     - name: Setup kernel for react native, increase watchers
  #       run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
  #     - run: yarn set-env-prod
  #       working-directory: react-native-app
  #     - run: yarn build
  #     - uses: maierj/fastlane-action@v1.4.0
  #       with:
  #         lane: "android internal"
  #         subdirectory: "react-native-app"
  #         bundle-install-path: 'vendor/bundle'

  deploy-ios-internal:
    # needs: increment-versions
    name: Deploy iOS internal
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      # - run: git clone git@github.com:Symbio-World/certificates.git
      #   env:
      #     GITHUB_API_TOKEN: ${{ secrets.DEVOPS_TOKEN }}
      - run: fastlane ios internal
        working-directory: react-native-app
        env:
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.DEVOPS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.DEVOPS_TOKEN }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
      # - uses: maierj/fastlane-action@v1.4.0
      #   with:
      #     lane: "ios internal"
      #     subdirectory: "react-native-app"
      #     bundle-install-path: "vendor/bundle"
      #   env:
      #     GITHUB_API_TOKEN: ${{ secrets.DEVOPS_TOKEN }}
      #     GITHUB_TOKEN: ${{ secrets.DEVOPS_TOKEN }}
      #     MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      #     FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
      #     FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
